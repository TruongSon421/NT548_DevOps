pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "catdog_classifier"
        DOCKER_REGISTRY_CREDENTIALS = credentials('dockerhub')
        DOCKER_REGISTRY = "docker.io"
        SONARQUBE_ENV = "SonarQube"
        SNYK_TOKEN = credentials('snyk_token')
    }

    stages {
        stage('Clone Repository') {
            steps {
                git url: 'https://github.com/yourusername/catdog-classifier.git', branch: 'main'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    withSonarQubeEnv('SonarQube') {
                        sh 'sonar-scanner -Dsonar.projectKey=catdog_classifier -Dsonar.sources=. -Dsonar.host.url=http://<sonarqube-ip>:9000 -Dsonar.login=$SONAR_TOKEN'
                    }
                }
            }
        }

        stage('Snyk Security Scan') {
            steps {
                script {
                    sh 'snyk auth $SNYK_TOKEN'
                    sh 'snyk test'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${env.BUILD_NUMBER}")
                }
            }
        }

        stage('Trivy Image Scan') {
            steps {
                script {
                    sh "trivy image --exit-code 1 --severity HIGH ${DOCKER_IMAGE}:${env.BUILD_NUMBER}"
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry("${DOCKER_REGISTRY}", "${DOCKER_REGISTRY_CREDENTIALS}") {
                        docker.image("${DOCKER_IMAGE}:${env.BUILD_NUMBER}").push()
                    }
                }
            }
        }

        stage('Deploy to Docker' ) {
            steps {
                script {
                    sh "docker run -d -p 5000:5000 --name catdog_classifier ${DOCKER_IMAGE}:${env.BUILD_NUMBER}"
                }
            }
        }
}
